name: Build IPQ U-Boot with Python 2.7

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

# Global environment variables configuration
env:
  # Source code configuration
  UBOOT_REPO_PATH: u-boot-2016

  # Toolchain configuration
  TOOLCHAIN_REPO_URL: https://github.com/1980490718/toolchain-arm_cortex-a7_gcc-5.2.0.git
  TOOLCHAIN_BASE_DIR: /home/runner/work/staging_dir
  TOOLCHAIN_SUBDIR: toolchain-arm_cortex-a7_gcc-5.2.0_musl-1.1.16_eabi/bin
  TOOLCHAIN_PATH: /home/runner/work/staging_dir/toolchain-arm_cortex-a7_gcc-5.2.0_musl-1.1.16_eabi/bin

  # Python configuration
  MINICONDA_URL: https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
  PYTHON_ENV_NAME: py27
  PYTHON_VERSION: 2.7
  PIP_INSTALL_URL: https://bootstrap.pypa.io/pip/2.7/get-pip.py

  # Time configuration
  TIMEZONE: Asia/Shanghai
  TIMESTAMP_FORMAT: "%Y%m%d-%H%M%S"
  RELEASE_DATE_FORMAT: "%Y-%m-%d %H:%M:%S %Z"

  # Build configuration
  ARCH: arm
  CROSS_COMPILE: arm-openwrt-linux-

jobs:
  build-ipq-uboot:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout source code
      - name: Checkout U-Boot repository
        uses: actions/checkout@v4
        with:
          path: ${{ env.UBOOT_REPO_PATH }}
          fetch-depth: 0  # get full git history for tag creation

      # 2. Install system dependencies
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            git \
            build-essential \
            flex \
            bison \
            m4 \
            libssl-dev \
            libncurses5-dev \
            libncursesw5-dev \
            zlib1g-dev \
            libc6-dev \
            curl \
            wget \
            lsb-release \
            device-tree-compiler \
            libfdt-dev \
            gzip

      # 3. Install Miniconda and Python 2.7
      - name: Install Miniconda and Python 2.7
        run: |
          # Install Miniconda
          wget ${{ env.MINICONDA_URL }} -O miniconda.sh
          bash miniconda.sh -b -p $HOME/miniconda
          echo "$HOME/miniconda/bin" >> $GITHUB_PATH

          # Create Python 2.7 environment
          $HOME/miniconda/bin/conda create -n ${{ env.PYTHON_ENV_NAME }} python=${{ env.PYTHON_VERSION }} -y

          # Install pip
          wget ${{ env.PIP_INSTALL_URL }} -O get-pip.py
          $HOME/miniconda/envs/${{ env.PYTHON_ENV_NAME }}/bin/python get-pip.py
          rm get-pip.py

          # Verify pip installation
          $HOME/miniconda/envs/${{ env.PYTHON_ENV_NAME }}/bin/pip --version

          # Create system symlinks
          sudo ln -sf $HOME/miniconda/envs/${{ env.PYTHON_ENV_NAME }}/bin/python${{ env.PYTHON_VERSION }} /usr/local/bin/python${{ env.PYTHON_VERSION }}
          sudo ln -sf $HOME/miniconda/envs/${{ env.PYTHON_ENV_NAME }}/bin/pip /usr/local/bin/pip${{ env.PYTHON_VERSION }}

      # 4. Verify Python installation
      - name: Verify Python 2.7 installation
        run: |
          python${{ env.PYTHON_VERSION }} --version
          pip${{ env.PYTHON_VERSION }} --version

      # 5. Clone toolchain repository
      - name: Clone toolchain repository
        run: |
          mkdir -p ${{ env.TOOLCHAIN_BASE_DIR }}
          cd ${{ env.TOOLCHAIN_BASE_DIR }}/..
          git clone ${{ env.TOOLCHAIN_REPO_URL }} staging_dir

      # 6. Set up toolchain environment variables
      - name: Set up toolchain environment
        run: |
          echo "TOOLCHAIN_PATH=${{ env.TOOLCHAIN_PATH }}" >> $GITHUB_ENV
          echo "PATH=${{ env.TOOLCHAIN_PATH }}:$PATH" >> $GITHUB_ENV
          echo "CROSS_COMPILE=${{ env.CROSS_COMPILE }}" >> $GITHUB_ENV
          echo "ARCH=${{ env.ARCH }}" >> $GITHUB_ENV

          # Verify toolchain installation
          ls -la ${{ env.TOOLCHAIN_PATH }}/${{ env.CROSS_COMPILE }}gcc || true
          ${{ env.TOOLCHAIN_PATH }}/${{ env.CROSS_COMPILE }}gcc --version || true

      # 7. Set up Python environment variables for build
      - name: Set up Python 2.7 environment for build
        run: |
          echo "PYTHONPATH=$HOME/miniconda/envs/${{ env.PYTHON_ENV_NAME }}/lib/python${{ env.PYTHON_VERSION }}/site-packages" >> $GITHUB_ENV
          echo "PYTHONBIN=$HOME/miniconda/envs/${{ env.PYTHON_ENV_NAME }}/bin/python" >> $GITHUB_ENV
          echo "PYTHON=$HOME/miniconda/envs/${{ env.PYTHON_ENV_NAME }}/bin/python" >> $GITHUB_ENV

      # 8. Verify dtc installation
      - name: Verify dtc installation
        run: |
          dtc --version

      # 9. Clean working directory and set timezone
      - name: Clean working directory and set timezone
        run: |
          cd ${{ env.UBOOT_REPO_PATH }}

          # Reset working directory
          git reset --hard HEAD
          git clean -fd

          # Set version information
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "-g${COMMIT_HASH}" > .scmversion
          echo "Set .scmversion to: -g${COMMIT_HASH}"

          echo "Working directory status:"
          git status

          # Set timezone
          sudo ln -sf /usr/share/zoneinfo/${{ env.TIMEZONE }} /etc/localtime
          echo "Current timezone: ${{ env.TIMEZONE }}"
          echo "Current time: $(date)"

          # Get build datetime
          BUILD_DATETIME=$(TZ=${{ env.TIMEZONE }} date +"${{ env.RELEASE_DATE_FORMAT }}")
          echo "BUILD_DATETIME=${BUILD_DATETIME}" >> $GITHUB_ENV

      # 10. Build U-Boot
      - name: Build U-Boot for all IPQ platforms
        run: |
          cd ${{ env.UBOOT_REPO_PATH }}

          # Set Python environment
          export PYTHON=$HOME/miniconda/envs/${{ env.PYTHON_ENV_NAME }}/bin/python
          export PYTHON2=$HOME/miniconda/envs/${{ env.PYTHON_ENV_NAME }}/bin/python
          export PATH=$HOME/miniconda/envs/${{ env.PYTHON_ENV_NAME }}/bin:$PATH

          echo "PYTHON environment variable: $PYTHON"
          $PYTHON --version

          # Define IPQ types directly (simpler approach)
          IPQ_TYPES=("ipq40xx" "ipq5018" "ipq5332" "ipq6018" "ipq806x" "ipq807x" "ipq9574")

          # Build each IPQ type
          for ipq_type in "${IPQ_TYPES[@]}"; do
            echo "================================================"
            echo "Building U-Boot for IPQ type: $ipq_type"
            echo "================================================"
            ./build.sh "$ipq_type"
          done

          echo "All IPQ platform builds completed!"

      # 11. Package U-Boot files
      - name: Package each U-Boot file individually with zip ultra compression and timestamp
        id: package
        run: |
          cd ${{ env.UBOOT_REPO_PATH }}/bin

          # Get timestamp
          TIMESTAMP=$(date +"${{ env.TIMESTAMP_FORMAT }}")
          echo "Build timestamp: $TIMESTAMP"
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

          # Create separate zip packages for each file
          for file in openwrt-*-u-boot.*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" | cut -d. -f1)
              zip -9 "${filename}-${TIMESTAMP}.zip" "$file"
              echo "Created: ${filename}-${TIMESTAMP}.zip"
            fi
          done

          # List created zip files
          ls -la *.zip
          echo "Individual zip packaging with timestamp completed!"

      # 12. Upload build artifacts (for Actions page download)
      - name: Upload U-Boot binaries as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: uboot-binaries-${{ env.TIMESTAMP }}
          path: ${{ env.UBOOT_REPO_PATH }}/bin/*.zip
          if-no-files-found: error
          retention-days: 90

      # 13. Create GitHub Release (only for push to main/master)
      - name: Create GitHub Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ env.TIMESTAMP }}
          name: U-Boot Build ${{ env.BUILD_DATETIME }}
          body: |
            Automated U-Boot build for IPQ platforms

            ## Build Information
            - **Build Time**: ${{ env.BUILD_DATETIME }}
            - **Build ID**: ${{ env.TIMESTAMP }}
            - **Source Commit**: ${{ github.sha }}
            - **Timezone**: ${{ env.TIMEZONE }}

            ## Supported IPQ Platforms
            - ipq40xx
            - ipq5018
            - ipq5332
            - ipq6018
            - ipq806x
            - ipq807x
            - ipq9574

            ## Important Notes
            Please select the appropriate U-Boot file according to your device model.

            ## Download
            You can also download the binaries from the Actions page:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          files: ${{ env.UBOOT_REPO_PATH }}/bin/openwrt-*-u-boot-*.zip
          draft: false
          prerelease: false
          generate_release_notes: false